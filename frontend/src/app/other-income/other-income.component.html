<div class="container">
  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card stat-success">
      <div class="stat-icon">üí∞</div>
      <div class="stat-content">
        <div class="stat-label">Total Income</div>
        <div class="stat-value">‚Çπ{{ stats.totalIncome | number:'1.2-2' }}</div>
      </div>
    </div>
    
    <div class="stat-card stat-info">
      <div class="stat-icon">üíµ</div>
      <div class="stat-content">
        <div class="stat-label">Cash</div>
        <div class="stat-value">‚Çπ{{ stats.totalCash | number:'1.2-2' }}</div>
      </div>
    </div>
    
    <div class="stat-card stat-purple">
      <div class="stat-icon">üè¶</div>
      <div class="stat-content">
        <div class="stat-label">Bank</div>
        <div class="stat-value">‚Çπ{{ stats.totalBank | number:'1.2-2' }}</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">üìù</div>
      <div class="stat-content">
        <div class="stat-label">Entry Count</div>
        <div class="stat-value">{{ stats.incomeCount }}</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Other Income</h2>
      <button (click)="openAddModal()" class="btn btn-primary">
        ‚ûï Add Income
      </button>
    </div>

    <!-- Date Filter Section -->
    <div class="filters-section">
      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-label">üìÖ Date Range</label>
          <select 
            class="filter-select" 
            [(ngModel)]="dateFilter" 
            (ngModelChange)="onDateFilterChange()"
          >
            <option value="all">All Time</option>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="this_week">This Week</option>
            <option value="last_week">Last Week</option>
            <option value="this_month">This Month</option>
            <option value="last_month">Last Month</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>

        <div class="filter-group" *ngIf="dateFilter === 'custom'">
          <label class="filter-label">From Date</label>
          <input 
            type="date" 
            class="filter-input" 
            [(ngModel)]="customStartDate" 
            (ngModelChange)="onCustomDateChange()"
          />
        </div>

        <div class="filter-group" *ngIf="dateFilter === 'custom'">
          <label class="filter-label">To Date</label>
          <input 
            type="date" 
            class="filter-input" 
            [(ngModel)]="customEndDate" 
            (ngModelChange)="onCustomDateChange()"
          />
        </div>
      </div>

      <div class="filter-results">
        Showing <strong>{{ filteredIncome.length }}</strong> of <strong>{{ incomeEntries.length }}</strong> entries
      </div>
    </div>

    <!-- Income Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Source</th>
            <th>Amount</th>
            <th>Cash</th>
            <th>Bank</th>
            <th>Payment Mode</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let income of filteredIncome">
            <td>{{ income.date | date:'dd MMM yyyy' }}</td>
            <td><span class="source-badge">{{ income.source }}</span></td>
            <td class="amount-cell">‚Çπ{{ income.amount | number:'1.2-2' }}</td>
            <td class="amount-cell">‚Çπ{{ income.cash_amount | number:'1.2-2' }}</td>
            <td class="amount-cell">‚Çπ{{ income.bank_amount | number:'1.2-2' }}</td>
            <td><span class="mode-badge mode-{{ income.payment_mode }}">{{ income.payment_mode | titlecase }}</span></td>
            <td>{{ income.notes || '-' }}</td>
            <td>
              <button (click)="openEditModal(income)" class="btn btn-sm btn-warning action-btn" *ngIf="isManager">Edit</button>
              <button (click)="deleteIncome(income)" class="btn btn-sm btn-danger action-btn" *ngIf="isManager">Delete</button>
            </td>
          </tr>
          <tr *ngIf="filteredIncome.length === 0">
            <td colspan="8" class="no-results">
              No income entries found for the selected date range
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Statistics Breakdown -->
  <div class="stats-row">
    <!-- By Source -->
    <div class="card" *ngIf="stats.bySource.length > 0">
      <div class="card-header">
        <h2 class="card-title">Income by Source</h2>
      </div>
      <div class="category-breakdown">
        <div class="category-item" *ngFor="let item of stats.bySource">
          <div class="category-info">
            <span class="category-name">{{ item.source }}</span>
            <span class="category-amount">‚Çπ{{ item.total | number:'1.2-2' }} ({{ item.count }})</span>
          </div>
          <div class="category-bar">
            <div class="category-bar-fill" [style.width.%]="(item.total / stats.totalIncome) * 100"></div>
          </div>
          <div class="category-percentage">
            {{ ((item.total / stats.totalIncome) * 100) | number:'1.1-1' }}%
          </div>
        </div>
      </div>
    </div>

    <!-- By Payment Mode -->
    <div class="card" *ngIf="stats.byMode.length > 0">
      <div class="card-header">
        <h2 class="card-title">Income by Payment Mode</h2>
      </div>
      <div class="category-breakdown">
        <div class="category-item" *ngFor="let item of stats.byMode">
          <div class="category-info">
            <span class="category-name">{{ item.mode | titlecase }}</span>
            <span class="category-amount">‚Çπ{{ item.total | number:'1.2-2' }} ({{ item.count }})</span>
          </div>
          <div class="category-bar">
            <div class="category-bar-fill mode-{{ item.mode }}" [style.width.%]="(item.total / stats.totalIncome) * 100"></div>
          </div>
          <div class="category-percentage">
            {{ ((item.total / stats.totalIncome) * 100) | number:'1.1-1' }}%
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Income Modal -->
<div *ngIf="showAddModal" class="modal-overlay" (click)="closeAddModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">Add Income Entry</h3>
      <button (click)="closeAddModal()" class="modal-close">√ó</button>
    </div>

    <div class="form-group">
      <label class="form-label">Date *</label>
      <input 
        type="date" 
        class="form-control" 
        [(ngModel)]="newIncome.date"
        required
      />
    </div>

    <div class="form-group">
      <label class="form-label">Income Source *</label>
      <select class="form-control" [(ngModel)]="newIncome.source" required>
        <option value="">Select Source</option>
        <option *ngFor="let source of sources" [value]="source">{{ source }}</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Amount (‚Çπ) *</label>
      <input 
        type="number" 
        class="form-control" 
        [(ngModel)]="newIncome.amount"
        min="0"
        step="0.01"
        placeholder="0.00"
        required
      />
    </div>

    <div class="form-group">
      <label class="form-label">Payment Mode *</label>
      <select class="form-control" [(ngModel)]="newIncome.payment_mode" (ngModelChange)="onPaymentModeChange()" required>
        <option value="cash">Cash</option>
        <option value="bank">Bank Account</option>
        <option value="split">Split (Cash + Bank)</option>
      </select>
    </div>

    <div *ngIf="newIncome.payment_mode === 'split'" class="split-amounts">
      <div class="form-group">
        <label class="form-label">Cash Amount (‚Çπ) *</label>
        <input 
          type="number" 
          class="form-control" 
          [(ngModel)]="newIncome.cash_amount"
          min="0"
          step="0.01"
          placeholder="0.00"
        />
      </div>

      <div class="form-group">
        <label class="form-label">Bank Amount (‚Çπ) *</label>
        <input 
          type="number" 
          class="form-control" 
          [(ngModel)]="newIncome.bank_amount"
          min="0"
          step="0.01"
          placeholder="0.00"
        />
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Notes</label>
      <textarea 
        class="form-control" 
        [(ngModel)]="newIncome.notes"
        rows="3"
        placeholder="Additional notes (optional)"
      ></textarea>
    </div>

    <div class="modal-footer">
      <button (click)="saveIncome()" class="btn btn-primary">Save Income</button>
      <button (click)="closeAddModal()" class="btn btn-secondary">Cancel</button>
    </div>
  </div>
</div>

<!-- Edit Income Modal -->
<div *ngIf="showEditModal && editIncome" class="modal-overlay" (click)="closeEditModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">Edit Income Entry</h3>
      <button (click)="closeEditModal()" class="modal-close">√ó</button>
    </div>

    <div class="form-group">
      <label class="form-label">Date *</label>
      <input 
        type="date" 
        class="form-control" 
        [(ngModel)]="editIncome.date"
        required
      />
    </div>

    <div class="form-group">
      <label class="form-label">Income Source *</label>
      <select class="form-control" [(ngModel)]="editIncome.source" required>
        <option value="">Select Source</option>
        <option *ngFor="let source of sources" [value]="source">{{ source }}</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Amount (‚Çπ) *</label>
      <input 
        type="number" 
        class="form-control" 
        [(ngModel)]="editIncome.amount"
        min="0"
        step="0.01"
        required
      />
    </div>

    <div class="form-group">
      <label class="form-label">Payment Mode *</label>
      <select class="form-control" [(ngModel)]="editIncome.payment_mode" (ngModelChange)="onEditPaymentModeChange()" required>
        <option value="cash">Cash</option>
        <option value="bank">Bank Account</option>
        <option value="split">Split (Cash + Bank)</option>
      </select>
    </div>

    <div *ngIf="editIncome.payment_mode === 'split'" class="split-amounts">
      <div class="form-group">
        <label class="form-label">Cash Amount (‚Çπ) *</label>
        <input 
          type="number" 
          class="form-control" 
          [(ngModel)]="editIncome.cash_amount"
          min="0"
          step="0.01"
        />
      </div>

      <div class="form-group">
        <label class="form-label">Bank Amount (‚Çπ) *</label>
        <input 
          type="number" 
          class="form-control" 
          [(ngModel)]="editIncome.bank_amount"
          min="0"
          step="0.01"
        />
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Notes</label>
      <textarea 
        class="form-control" 
        [(ngModel)]="editIncome.notes"
        rows="3"
      ></textarea>
    </div>

    <div class="modal-footer">
      <button (click)="updateIncome()" class="btn btn-primary">Update Income</button>
      <button (click)="closeEditModal()" class="btn btn-secondary">Cancel</button>
    </div>
  </div>
</div>

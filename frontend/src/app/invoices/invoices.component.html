<div class="container">
  <!-- Statistics Cards -->
  <div class="stats-grid" *ngIf="!isSalesPerson">
    <div class="stat-card">
      <div class="stat-icon">ðŸ’°</div>
      <div class="stat-content">
        <div class="stat-label">Total Sales</div>
        <div class="stat-value">â‚¹{{ stats.totalSales | number:'1.2-2' }}</div>
      </div>
    </div>
    
    <div class="stat-card stat-info">
      <div class="stat-icon">ðŸ§¾</div>
      <div class="stat-content">
        <div class="stat-label">Total Invoices</div>
        <div class="stat-value">{{ stats.totalInvoices }}</div>
      </div>
    </div>
    
    <div class="stat-card stat-purple">
      <div class="stat-icon">ðŸ“Š</div>
      <div class="stat-content">
        <div class="stat-label">Avg Order Value</div>
        <div class="stat-value">â‚¹{{ stats.averageOrderValue | number:'1.2-2' }}</div>
      </div>
    </div>
  </div>

  <!-- Payment Method Breakdown -->
  <div class="payment-breakdown" *ngIf="!isSalesPerson">
    <div class="payment-card cash-card">
      <div class="payment-icon">ðŸ’µ</div>
      <div class="payment-content">
        <div class="payment-label">Cash</div>
        <div class="payment-value">â‚¹{{ stats.cashAmount | number:'1.2-2' }}</div>
      </div>
    </div>
    
    <div class="payment-card upi-card">
      <div class="payment-icon">ðŸ“±</div>
      <div class="payment-content">
        <div class="payment-label">UPI</div>
        <div class="payment-value">â‚¹{{ stats.upiAmount | number:'1.2-2' }}</div>
      </div>
    </div>
    
    <div class="payment-card card-card" *ngIf="stats.cardAmount > 0">
      <div class="payment-icon">ðŸ’³</div>
      <div class="payment-content">
        <div class="payment-label">Card</div>
        <div class="payment-value">â‚¹{{ stats.cardAmount | number:'1.2-2' }}</div>
      </div>
    </div>
    
    <div class="payment-card other-card" *ngIf="stats.otherAmount > 0">
      <div class="payment-icon">ðŸ”„</div>
      <div class="payment-content">
        <div class="payment-label">Other</div>
        <div class="payment-value">â‚¹{{ stats.otherAmount | number:'1.2-2' }}</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Sales / Invoices</h2>
      <div class="search-container">
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search by invoice #, customer name, or phone..."
          [(ngModel)]="searchTerm"
          (ngModelChange)="applySearch()"
        />
      </div>
    </div>

    <!-- Date Filter Section -->
    <div class="filters-section" *ngIf="!isSalesPerson">
      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-label">ðŸ“… Date Range</label>
          <select 
            class="filter-select" 
            [(ngModel)]="dateFilter" 
            (ngModelChange)="onDateFilterChange()"
          >
            <option value="all">All Time</option>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="this_week">This Week</option>
            <option value="last_week">Last Week</option>
            <option value="this_month">This Month</option>
            <option value="last_month">Last Month</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>

        <div class="filter-group" *ngIf="dateFilter === 'custom'">
          <label class="filter-label">From Date</label>
          <input 
            type="date" 
            class="filter-input" 
            [(ngModel)]="customStartDate" 
            (ngModelChange)="onCustomDateChange()"
          />
        </div>

        <div class="filter-group" *ngIf="dateFilter === 'custom'">
          <label class="filter-label">To Date</label>
          <input 
            type="date" 
            class="filter-input" 
            [(ngModel)]="customEndDate" 
            (ngModelChange)="onCustomDateChange()"
          />
        </div>
      </div>

      <div class="filter-results">
        Showing <strong>{{ filteredInvoices.length }}</strong> of <strong>{{ invoices.length }}</strong> invoices
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Invoice #</th>
            <th>Customer</th>
            <th>Date</th>
            <th>Payment Type</th>
            <th>Items</th>
            <th>Total</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let invoice of filteredInvoices">
            <td>{{ invoice.invoice_number }}</td>
            <td>{{ invoice.customer_name || 'Walk-in' }}</td>
            <td>{{ invoice.created_at | date:'short' }}</td>
            <td>
              <span *ngIf="invoice.payment_method === 'split'" style="font-size: 0.85em;">
                ðŸ’µ â‚¹{{ invoice.cash_amount | number:'1.0-0' }} + ðŸ“± â‚¹{{ invoice.upi_amount | number:'1.0-0' }}
              </span>
              <span *ngIf="invoice.payment_method !== 'split'">
                {{ invoice.payment_method | titlecase }}
              </span>
            </td>
            <td>{{ invoice.items.length }}</td>
            <td>â‚¹{{ invoice.total | number:'1.2-2' }}</td>
            <td>
              <button (click)="viewInvoice(invoice)" class="btn btn-sm btn-primary action-btn">View</button>
              <button 
                (click)="shareOnWhatsApp(invoice)" 
                class="btn btn-sm btn-success action-btn whatsapp-btn"
                [disabled]="!hasPhoneNumber(invoice)"
                [title]="hasPhoneNumber(invoice) ? 'Share PDF on WhatsApp' : 'Customer phone number not available'"
              >
                <svg class="whatsapp-icon" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                </svg>
                WhatsApp
              </button>
              <button (click)="openEditModal(invoice)" class="btn btn-sm btn-warning action-btn" *ngIf="isManager || isSalesPerson">Edit</button>
              <button (click)="deleteInvoice(invoice)" class="btn btn-sm btn-danger action-btn" *ngIf="isManager">Delete</button>
            </td>
          </tr>
          <tr *ngIf="filteredInvoices.length === 0">
            <td colspan="7" class="no-results">
              No invoices found for the selected date range
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Invoice Modal -->
<div *ngIf="showModal && selectedInvoice" class="modal-overlay" (keydown.escape)="closeModal()" tabindex="-1">
  <div class="modal" style="max-width: 800px;">
    <div class="modal-header">
      <h3 class="modal-title">Invoice {{ selectedInvoice.invoice_number }}</h3>
      <button (click)="closeModal()" class="modal-close">Ã—</button>
    </div>

    <div class="invoice-content">
      <div class="invoice-company-header">
        <h1>{{ storeSettings?.store_name || 'CuteCart' }}</h1>
        <p *ngIf="storeSettings?.store_address">{{ storeSettings?.store_address }}</p>
        <p *ngIf="storeSettings?.store_phone">Phone: {{ storeSettings?.store_phone }}</p>
        <p *ngIf="storeSettings?.store_email">Email: {{ storeSettings?.store_email }}</p>
        <p *ngIf="storeSettings?.store_website">Website: {{ storeSettings?.store_website }}</p>
      </div>

      <div class="invoice-title-section">
        <h2>INVOICE</h2>
        <div class="invoice-meta">
          <p><strong>Invoice #:</strong> {{ selectedInvoice.invoice_number }}</p>
          <p><strong>Date:</strong> {{ selectedInvoice.created_at | date:'d MMMM yyyy \'at\' hh:mm a' }}</p>
        </div>
      </div>

      <div class="invoice-bill-to">
        <h3>Bill To:</h3>
        <p>{{ selectedInvoice.customer_name || 'Walk-in Customer' }}</p>
        <p *ngIf="selectedInvoice.customer_phone">Phone: {{ selectedInvoice.customer_phone }}</p>
      </div>

      <div class="invoice-table-container">
        <table class="invoice-table">
          <thead>
            <tr>
              <th>ITEM</th>
              <th>QTY</th>
              <th>PRICE</th>
              <th>TOTAL</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of selectedInvoice.items">
              <td>{{ item.product_name }}</td>
              <td>{{ item.quantity }}</td>
              <td>â‚¹{{ item.unit_price | number:'1.2-2' }}</td>
              <td>â‚¹{{ item.total_price | number:'1.2-2' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="invoice-totals-section">
        <div class="invoice-total-row">
          <span>Subtotal:</span>
          <span>â‚¹{{ selectedInvoice.subtotal | number:'1.2-2' }}</span>
        </div>
        <div class="invoice-total-row" *ngIf="selectedInvoice.tax_rate > 0">
          <span>Tax ({{ selectedInvoice.tax_rate }}%):</span>
          <span>â‚¹{{ selectedInvoice.tax_amount | number:'1.2-2' }}</span>
        </div>
        <div class="invoice-total-row" *ngIf="selectedInvoice.discount">
          <span>Discount:</span>
          <span>-â‚¹{{ selectedInvoice.discount | number:'1.2-2' }}</span>
        </div>
        <div class="invoice-total-row grand-total-invoice">
          <span>Total:</span>
          <span>â‚¹{{ selectedInvoice.total | number:'1.2-2' }}</span>
        </div>
      </div>

      <div class="invoice-payment-info">
        <p *ngIf="selectedInvoice.payment_method !== 'split'">
          <strong>Payment Method:</strong> {{ selectedInvoice.payment_method | titlecase }}
        </p>
        <div *ngIf="selectedInvoice.payment_method === 'split'">
          <p><strong>Payment Method:</strong> Split Payment</p>
          <div class="payment-breakdown-detail">
            <p *ngIf="selectedInvoice.cash_amount && selectedInvoice.cash_amount > 0">
              ðŸ’µ Cash: â‚¹{{ selectedInvoice.cash_amount | number:'1.2-2' }}
            </p>
            <p *ngIf="selectedInvoice.upi_amount && selectedInvoice.upi_amount > 0">
              ðŸ“± UPI: â‚¹{{ selectedInvoice.upi_amount | number:'1.2-2' }}
            </p>
          </div>
        </div>
      </div>

      <div class="invoice-footer" *ngIf="storeSettings?.invoice_footer">
        <p>{{ storeSettings?.invoice_footer }}</p>
      </div>
    </div>

    <div class="modal-footer">
      <button (click)="printInvoice()" class="btn btn-primary">Print</button>
      <button 
        (click)="shareOnWhatsApp(selectedInvoice)" 
        class="btn btn-success whatsapp-btn"
        [disabled]="!hasPhoneNumber(selectedInvoice)"
        [title]="hasPhoneNumber(selectedInvoice) ? 'Share PDF on WhatsApp' : 'Customer phone number not available'"
      >
        <svg class="whatsapp-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
        </svg>
        Share PDF
      </button>
      <button (click)="closeModal()" class="btn btn-secondary">Close</button>
    </div>
  </div>
</div>

<!-- Edit Invoice Modal -->
<div *ngIf="showEditModal && editInvoice" class="modal-overlay" (keydown.escape)="closeEditModal()" tabindex="-1">
  <div class="modal" style="max-width: 500px;">
    <div class="modal-header">
      <h3 class="modal-title">Edit Invoice {{ editInvoice.invoice_number }}</h3>
      <button (click)="closeEditModal()" class="modal-close">Ã—</button>
    </div>

    <div class="form-group">
      <label class="form-label">Invoice Total (Read-only)</label>
      <input 
        type="text" 
        class="form-control" 
        [value]="'â‚¹' + (editInvoice.total | number:'1.2-2')"
        readonly
        style="background-color: #f5f5f5; cursor: not-allowed;"
      />
    </div>

    <div class="form-group">
      <label class="form-label">Customer Name</label>
      <input 
        type="text" 
        class="form-control" 
        [(ngModel)]="editInvoice.customer_name"
        placeholder="Customer Name"
      />
    </div>

    <div class="form-group">
      <label class="form-label">Customer Phone</label>
      <input 
        type="text" 
        class="form-control" 
        [(ngModel)]="editInvoice.customer_phone"
        placeholder="Phone Number"
      />
    </div>

    <div class="form-group">
      <label class="form-label">Payment Method</label>
      <select class="form-control" [(ngModel)]="editInvoice.payment_method">
        <option value="cash">Cash</option>
        <option value="upi">UPI</option>
        <option value="split">Split Payment</option>
      </select>
    </div>

    <!-- Split Payment Inputs -->
    <div *ngIf="editInvoice.payment_method === 'split'" style="margin-top: 15px;">
      <div class="form-group">
        <label class="form-label">ðŸ’µ Cash Amount</label>
        <input 
          type="number" 
          class="form-control" 
          [(ngModel)]="editInvoice.cash_amount"
          (ngModelChange)="onEditCashAmountChange()"
          min="0"
          step="0.01"
          placeholder="0.00"
        />
      </div>

      <div class="form-group">
        <label class="form-label">ðŸ“± UPI Amount</label>
        <input 
          type="number" 
          class="form-control" 
          [(ngModel)]="editInvoice.upi_amount"
          (ngModelChange)="onEditUpiAmountChange()"
          min="0"
          step="0.01"
          placeholder="0.00"
        />
      </div>

      <div class="form-group" style="padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>Total Paid:</span>
          <span [style.color]="isEditPaymentValid() ? 'green' : 'red'" style="font-weight: bold;">
            â‚¹{{ ((editInvoice.cash_amount || 0) + (editInvoice.upi_amount || 0)) | number:'1.2-2' }}
          </span>
        </div>
        <div *ngIf="!isEditPaymentValid()" style="display: flex; justify-content: space-between; color: red;">
          <span>Difference:</span>
          <span style="font-weight: bold;">
            â‚¹{{ (editInvoice.total - ((editInvoice.cash_amount || 0) + (editInvoice.upi_amount || 0))) | number:'1.2-2' }}
          </span>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button (click)="closeEditModal()" class="btn btn-secondary">Cancel</button>
      <button 
        (click)="saveInvoiceEdit()" 
        class="btn btn-primary"
        [disabled]="editInvoice.payment_method === 'split' && !isEditPaymentValid()"
      >
        Save Changes
      </button>
    </div>
  </div>
</div>

<div class="container">
  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üì¶</div>
      <div class="stat-content">
        <div class="stat-label">Total Products</div>
        <div class="stat-value">{{ stats.totalProducts }}</div>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">üí∞</div>
      <div class="stat-content">
        <div class="stat-label">Inventory Value</div>
        <div class="stat-value">‚Çπ{{ stats.inventoryValue | number:'1.2-2' }}</div>
      </div>
    </div>
    
    <div class="stat-card stat-warning">
      <div class="stat-icon">‚ö†Ô∏è</div>
      <div class="stat-content">
        <div class="stat-label">Low Stock Items</div>
        <div class="stat-value">{{ stats.lowStockCount }}</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Products</h2>
      <div class="header-actions">
        <button (click)="downloadSampleCSV()" class="btn btn-secondary" title="Download sample CSV template">
          üìÑ Sample CSV
        </button>
        <button (click)="triggerFileInput()" class="btn btn-success" title="Import products from CSV">
          üì• Import CSV
        </button>
        <button (click)="exportToCSV()" class="btn btn-info" title="Export all products to CSV">
          üì§ Export CSV
        </button>
        <button (click)="openAddModal()" class="btn btn-primary">
          ‚ûï Add Product
        </button>
      </div>
    </div>
    
    <!-- Hidden file input for CSV import -->
    <input 
      type="file" 
      id="csvFileInput" 
      accept=".csv" 
      (change)="onFileSelected($event)" 
      style="display: none;"
    />

    <!-- Search and Filter Section -->
    <div class="filters-section">
      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-label">üîç Search by ID or Name</label>
          <input 
            type="text" 
            class="filter-input" 
            [(ngModel)]="searchTerm" 
            (ngModelChange)="onSearchChange()"
            placeholder="Enter product ID or name..."
          />
        </div>

        <div class="filter-group">
          <label class="filter-label">üìÇ Category</label>
          <select 
            class="filter-select" 
            [(ngModel)]="selectedCategory" 
            (ngModelChange)="onCategoryChange()"
          >
            <option value="">All Categories</option>
            <option *ngFor="let category of stats.categories" [value]="category">
              {{ category }}
            </option>
          </select>
        </div>

        <div class="filter-group checkbox-group">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="showLowStockOnly" 
              (ngModelChange)="onLowStockToggle()"
            />
            <span>‚ö†Ô∏è Low Stock Only (< {{ lowStockThreshold }})</span>
          </label>
        </div>

        <div class="filter-group">
          <button (click)="clearFilters()" class="btn btn-secondary btn-sm">
            üîÑ Clear Filters
          </button>
        </div>
      </div>

      <div class="filter-results">
        Showing <strong>{{ filteredProducts.length }}</strong> of <strong>{{ products.length }}</strong> products
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Category</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let product of filteredProducts">
            <td>{{ product.id }}</td>
            <td>{{ product.name }}</td>
            <td>‚Çπ{{ product.price | number:'1.2-2' }}</td>
            <td>
              <span [class.stock-badge]="true" [class.stock-low]="(product.stock || 0) < lowStockThreshold">
                {{ product.stock || 0 }}
              </span>
            </td>
            <td>{{ product.category || '-' }}</td>
            <td>
              <button (click)="openAddStockModal(product)" class="btn btn-sm btn-success action-btn" title="Add Stock">üì¶ Add Stock</button>
              <button (click)="openStockHistoryModal(product)" class="btn btn-sm btn-info action-btn" title="View Stock History">üìä History</button>
              <button (click)="openEditModal(product)" class="btn btn-sm btn-warning action-btn">Edit</button>
              <button (click)="deleteProduct(product)" class="btn btn-sm btn-danger action-btn">Delete</button>
            </td>
          </tr>
          <tr *ngIf="filteredProducts.length === 0">
            <td colspan="6" class="no-results">
              No products found matching your criteria
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal -->
<div *ngIf="showModal" class="modal-overlay" (keydown.escape)="closeModal()" tabindex="-1">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">{{ editMode ? 'Edit' : 'Add' }} Product</h3>
      <button (click)="closeModal()" class="modal-close">√ó</button>
    </div>

    <div class="form-group">
      <label class="form-label">Product ID</label>
      <input type="text" class="form-control" [(ngModel)]="currentProduct.id" [disabled]="editMode" />
    </div>

    <div class="form-group">
      <label class="form-label">Name *</label>
      <input type="text" class="form-control" [(ngModel)]="currentProduct.name" required />
    </div>

    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea class="form-control" [(ngModel)]="currentProduct.description"></textarea>
    </div>

    <div class="form-group">
      <label class="form-label">Purchase Price *</label>
      <input 
        type="number" 
        class="form-control" 
        [(ngModel)]="currentProduct.purchase_price" 
        (ngModelChange)="onPurchasePriceChange()"
        required 
      />
    </div>

    <div class="form-group">
      <label class="form-label">Selling Price (Auto-calculated with 40% margin)</label>
      <input 
        type="number" 
        class="form-control" 
        [(ngModel)]="currentProduct.price" 
        required 
      />
      <small class="form-text">Price is auto-calculated from purchase price. You can adjust it manually.</small>
    </div>

    <div class="form-group">
      <label class="form-label">Stock</label>
      <input type="number" class="form-control" [(ngModel)]="currentProduct.stock" />
    </div>

    <div class="form-group">
      <label class="form-label">Category</label>
      <small class="form-text-help">Type a new category or select from existing ones</small>
      
      <div class="category-input-wrapper">
        <input 
          type="text" 
          class="form-control" 
          [(ngModel)]="currentProduct.category"
          list="categoryList"
          placeholder="Type or select category"
        />
        <datalist id="categoryList">
          <option *ngFor="let cat of stats.categories" [value]="cat">{{ cat }}</option>
        </datalist>
        <button 
          type="button" 
          class="btn btn-sm btn-danger delete-category-btn" 
          *ngIf="currentProduct.category && stats.categories.includes(currentProduct.category)"
          (click)="deleteCategory(currentProduct.category)"
          title="Delete this category"
        >
          üóëÔ∏è
        </button>
      </div>
    </div>

    <div class="modal-footer">
      <button (click)="closeModal()" class="btn btn-secondary">Cancel</button>
      <button (click)="saveProduct()" class="btn btn-primary">Save</button>
    </div>
  </div>
</div>

<!-- Add Stock Modal -->
<div *ngIf="showStockModal" class="modal-overlay" (keydown.escape)="closeStockModal()" tabindex="-1">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">üì¶ Add Stock - {{ stockProduct?.name }}</h3>
      <button (click)="closeStockModal()" class="modal-close">√ó</button>
    </div>

    <div class="modal-body">
      <div class="current-info-box">
        <h4>Current Product Info</h4>
        <div class="info-row">
          <span class="info-label">Current Stock:</span>
          <span class="info-value">{{ stockProduct?.stock || 0 }} units</span>
        </div>
        <div class="info-row">
          <span class="info-label">Avg Purchase Price:</span>
          <span class="info-value">‚Çπ{{ stockProduct?.purchase_price || 0 | number:'1.2-2' }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Current Sale Price:</span>
          <span class="info-value">‚Çπ{{ stockProduct?.price || 0 | number:'1.2-2' }}</span>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Quantity to Add *</label>
        <input 
          type="number" 
          class="form-control" 
          [(ngModel)]="stockQuantity"
          min="1"
          step="1"
          placeholder="Enter quantity"
          required
          autofocus
        />
      </div>

      <div class="form-group">
        <label class="form-label">Purchase Price (per unit) *</label>
        <input 
          type="number" 
          class="form-control" 
          [(ngModel)]="stockPurchasePrice"
          (ngModelChange)="onStockPurchasePriceChange()"
          min="0"
          step="0.01"
          placeholder="Enter purchase price"
          required
        />
        <small class="form-text">
          <span *ngIf="stockPurchasePrice !== stockProduct?.purchase_price && stockProduct?.purchase_price">
            ‚ö†Ô∏è Different from current avg (‚Çπ{{ stockProduct?.purchase_price | number:'1.2-2' }}). 
            System will calculate new average.
          </span>
        </small>
      </div>

      <div class="form-group">
        <label class="form-label">Sale Price (per unit) *</label>
        <input 
          type="number" 
          class="form-control" 
          [(ngModel)]="stockSalePrice"
          min="0"
          step="0.01"
          placeholder="Enter sale price"
          required
        />
        <small class="form-text">
          Auto-calculated with 40% margin. You can adjust manually.
          <span *ngIf="stockSalePrice !== stockProduct?.price && stockProduct?.price">
            ‚ö†Ô∏è Different from current price (‚Çπ{{ stockProduct?.price | number:'1.2-2' }})
          </span>
        </small>
      </div>

      <div class="form-group" *ngIf="stockPurchasePrice > 0 && stockSalePrice > 0">
        <div class="profit-info-box">
          <div class="profit-row">
            <span>Profit per unit:</span>
            <strong [class.profit-positive]="stockSalePrice > stockPurchasePrice" 
                    [class.profit-negative]="stockSalePrice < stockPurchasePrice">
              ‚Çπ{{ (stockSalePrice - stockPurchasePrice) | number:'1.2-2' }}
            </strong>
          </div>
          <div class="profit-row">
            <span>Profit margin:</span>
            <strong [class.profit-positive]="stockSalePrice > stockPurchasePrice" 
                    [class.profit-negative]="stockSalePrice < stockPurchasePrice">
              {{ stockPurchasePrice > 0 ? (((stockSalePrice - stockPurchasePrice) / stockPurchasePrice) * 100) : 0 | number:'1.2-2' }}%
            </strong>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Notes (Optional)</label>
        <textarea 
          class="form-control" 
          [(ngModel)]="stockNotes"
          rows="3"
          placeholder="Add any notes about this stock addition..."
        ></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button (click)="closeStockModal()" class="btn btn-secondary">Cancel</button>
      <button (click)="addStock()" class="btn btn-success">Add Stock</button>
    </div>
  </div>
</div>

<!-- Stock History Modal -->
<div *ngIf="showStockHistoryModal" class="modal-overlay" (keydown.escape)="closeStockHistoryModal()" tabindex="-1">
  <div class="modal modal-large">
    <div class="modal-header">
      <h3 class="modal-title">üìä Stock History - {{ stockProduct?.name }}</h3>
      <button (click)="closeStockHistoryModal()" class="modal-close">√ó</button>
    </div>

    <div class="modal-body">
      <div class="stock-summary" *ngIf="stockSummary">
        <h4>Summary</h4>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="summary-label">Current Stock:</span>
            <span class="summary-value">{{ stockSummary.currentStock }} units</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Avg Purchase Price:</span>
            <span class="summary-value">‚Çπ{{ stockSummary.avgPurchasePrice | number:'1.2-2' }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Sale Price:</span>
            <span class="summary-value">‚Çπ{{ stockSummary.salePrice | number:'1.2-2' }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Profit/Unit:</span>
            <span class="summary-value" [class.profit-positive]="stockSummary.profitPerUnit > 0" 
                  [class.profit-negative]="stockSummary.profitPerUnit < 0">
              ‚Çπ{{ stockSummary.profitPerUnit | number:'1.2-2' }} ({{ stockSummary.profitMarginPercent | number:'1.2-2' }}%)
            </span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total Batches:</span>
            <span class="summary-value">{{ stockSummary.totalBatches }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total Stock Added:</span>
            <span class="summary-value">{{ stockSummary.totalStockAdded }} units</span>
          </div>
        </div>
      </div>

      <h4 style="margin-top: 1.5rem;">Recent Stock Additions</h4>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Quantity</th>
              <th>Purchase Price</th>
              <th>Sale Price</th>
              <th>Notes</th>
              <th>Added By</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let batch of stockHistory">
              <td>{{ batch.created_at | date:'dd MMM yyyy, hh:mm a' }}</td>
              <td><strong>{{ batch.quantity }}</strong> units</td>
              <td>‚Çπ{{ batch.purchase_price | number:'1.2-2' }}</td>
              <td>‚Çπ{{ batch.sale_price | number:'1.2-2' }}</td>
              <td>{{ batch.notes || '-' }}</td>
              <td>{{ batch.added_by || '-' }}</td>
            </tr>
            <tr *ngIf="stockHistory.length === 0">
              <td colspan="6" class="no-results">No stock history found</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="modal-footer">
      <button (click)="closeStockHistoryModal()" class="btn btn-secondary">Close</button>
    </div>
  </div>
</div>
